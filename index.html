<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>巡回リスト（シンプル同期）</title>
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--chip:#eff4ff;}
    html,body{margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#f6f7fb;color:var(--fg)}
    .appbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid #e6e8ef}
    .title{font-size:20px;font-weight:800}
    .btns{display:flex;gap:10px}
    .btn{appearance:none;border:1px solid #d7dbe7;padding:8px 14px;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--chip);border-color:#c9d6ff;color:#1e40af}
    .wrap{max-width:820px;margin:18px auto;padding:0 14px 60px}
    .hint{margin:6px 2px 14px;color:var(--muted);font-size:13px}
    .cards{display:grid;grid-template-columns:1fr;gap:14px}
    .card{display:block;text-decoration:none;color:inherit;background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:18px 16px;box-shadow:0 1px 0 rgba(8,15,35,.03)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .meta{display:flex;gap:14px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f2f5fb;border:1px solid #e6e8ef}
    .empty{margin:28px 2px 0 2px;color:var(--muted);font-size:14px}
    /* 簡易モーダル */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.show{display:flex}
    .dialog{width:min(420px,90vw);background:#111827;color:#fff;border-radius:12px;padding:16px 16px}
    .barwrap{height:8px;background:#1f2937;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399)}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="title">巡回リスト</div>
    <div class="btns">
      <button id="recalcBtn" class="btn">再計算</button>
      <button id="syncBtn" class="btn btn-primary">同期</button>
    </div>
  </header>

  <main class="wrap">
    <p id="statusText" class="hint">GASと同期して各エリアに反映します。</p>

    <section id="cityCards" class="cards">
      <a id="card-yamato" class="card" href="yamato.html" data-city="大和市">
        <h2>大和市</h2>
        <div class="meta">
          <span class="chip">済 <span id="yamato-done">0</span></span>
          <span class="chip">停 <span id="yamato-stop">0</span></span>
          <span class="chip">不要 <span id="yamato-skip">0</span></span>
          <span class="chip">総 <span id="yamato-total">0</span></span>
        </div>
      </a>
      <a id="card-ebina" class="card" href="ebina.html" data-city="海老名市">
        <h2>海老名市</h2>
        <div class="meta">
          <span class="chip">済 <span id="ebina-done">0</span></span>
          <span class="chip">停 <span id="ebina-stop">0</span></span>
          <span class="chip">不要 <span id="ebina-skip">0</span></span>
          <span class="chip">総 <span id="ebina-total">0</span></span>
        </div>
      </a>
      <a id="card-chofu" class="card" href="chofu.html" data-city="調布市">
        <h2>調布市</h2>
        <div class="meta">
          <span class="chip">済 <span id="chofu-done">0</span></span>
          <span class="chip">停 <span id="chofu-stop">0</span></span>
          <span class="chip">不要 <span id="chofu-skip">0</span></span>
          <span class="chip">総 <span id="chofu-total">0</span></span>
        </div>
      </a>
    </section>

    <p id="overallHint" class="empty">まだ同期されていません</p>
  </main>

  <!-- 簡易モーダル -->
  <div id="progressModal" class="modal" aria-hidden="true">
    <div class="dialog">
      <div id="progressTitle">同期中…</div>
      <div class="barwrap"><div id="progressBar" class="bar"></div></div>
    </div>
  </div>

  <script>
  // ===== 設定 =====
  const GAS_URL = (window.GAS_URL || "https://script.google.com/macros/s/AKfycby9RpFiUbYu6YX6JW9XfwbDx36_4AIlGEQMOxR3SnxgNdoRUJKfyxvF3b1SEYwuHb3X/exec");
  const LS_KEY = (city) => \`junkai:city:\${city}\`;
  const CITIES = ["大和市","海老名市","調布市"];

  // ===== DOM =====
  const els = {
    syncBtn: document.getElementById("syncBtn"),
    recalcBtn: document.getElementById("recalcBtn"),
    statusText: document.getElementById("statusText"),
    modal: document.getElementById("progressModal"),
    bar: document.getElementById("progressBar"),
    title: document.getElementById("progressTitle"),
    totals: {
      "大和市": { done:"#yamato-done", stop:"#yamato-stop", skip:"#yamato-skip", total:"#yamato-total" },
      "海老名市": { done:"#ebina-done", stop:"#ebina-stop", skip:"#ebina-skip", total:"#ebina-total" },
      "調布市": { done:"#chofu-done", stop:"#chofu-stop", skip:"#chofu-skip", total:"#chofu-total" }
    }
  };
  const $ = (s)=>document.querySelector(s);

  // ===== 簡易モーダル制御 =====
  let progTimer=null, prog=0;
  function openProgress(text){
    if(els.title) els.title.textContent = text||"同期中…";
    if(els.modal) els.modal.classList.add("show");
    prog=0;
    if(els.bar) els.bar.style.width="0%";
    progTimer=setInterval(()=>{
      prog=Math.min(98, prog+3);
      if(els.bar) els.bar.style.width=prog+"%";
    }, 100);
  }
  function closeProgress(text){
    if(text && els.title) els.title.textContent=text;
    if(progTimer){ clearInterval(progTimer); progTimer=null; }
    if(els.bar) els.bar.style.width="100%";
    setTimeout(()=>{ if(els.modal) els.modal.classList.remove("show"); if(els.bar) els.bar.style.width="0%"; }, 500);
  }

  // ===== 同期 =====
  async function doSync(){
    try{
      els.statusText.textContent="同期中…";
      openProgress("同期中…");

      const res = await fetch(\`\${GAS_URL}?action=pull&ts=\${Date.now()}\`, {cache:"no-store"});
      const json = await res.json().catch(()=> ({}));

      // 2系統の形式を許容： {ok:true,data:[...]} か、配列そのもの
      const rows = Array.isArray(json?.data) ? json.data : (Array.isArray(json) ? json : []);
      if(!Array.isArray(rows)){
        els.statusText.textContent="取得失敗：形式エラー";
        closeProgress("同期失敗");
        return;
      }

      const buckets = { "大和市":[], "海老名市":[], "調布市":[] };
      rows.forEach(r=>{
        let city, station, model, number, status, checked, index, last_inspected_at;
        if(Array.isArray(r)){ // 配列の配列
          city   = String(r[0]??"").trim();
          station= String(r[1]??"").trim();
          model  = String(r[2]??"").trim();
          number = String(r[3]??"").trim();
          status = String(r[4]??"normal").trim();
          checked= !!r[5];
          index  = parseInt(r[6]||0,10)||0;
          last_inspected_at = String(r[7]??"").trim();
        }else{ // レコード形式
          city   = String(r.city??"").trim();
          station= String(r.station??"").trim();
          model  = String(r.model??"").trim();
          number = String(r.number??r.plate??"").trim();
          status = String(r.status??"normal").trim();
          checked= !!r.checked;
          index  = parseInt(r.index||0,10)||0;
          last_inspected_at = String(r.last_inspected_at??"").trim();
        }
        if(buckets[city]){
          buckets[city].push({city,station,model,number,status,checked,index,last_inspected_at});
        }
      });

      // 保存
      CITIES.forEach(c=> localStorage.setItem(LS_KEY(c), JSON.stringify(buckets[c])) );
      // 再計算
      recalcAll();
      els.statusText.textContent="同期完了！";
      closeProgress("同期完了！");
    }catch(e){
      console.error(e);
      els.statusText.textContent="同期失敗：通信エラー";
      closeProgress("同期失敗");
      alert("同期に失敗しました。通信状況を確認してください。");
    }
  }

  // ===== 再計算 =====
  function recalcAll(){
    let overall=0;
    for(const city of CITIES){
      const s = localStorage.getItem(LS_KEY(city));
      const arr = s ? (JSON.parse(s) || []) : [];
      overall += arr.length;
      const cnt = {done:0,stop:0,skip:0,total:arr.length};
      arr.forEach(it=>{
        if(it.status==="stop") cnt.stop++;
        else if(it.status==="skip") cnt.skip++;
        if(it.checked || it.status==="done") cnt.done++;
      });
      const map = els.totals[city];
      $(map.done).textContent=cnt.done;
      $(map.stop).textContent=cnt.stop;
      $(map.skip).textContent=cnt.skip;
      $(map.total).textContent=cnt.total;
    }
    document.getElementById("overallHint").textContent = overall>0 ? \`総件数：\${overall}\` : "まだ同期されていません";
  }

  // ===== 配線 =====
  els.syncBtn?.addEventListener("click", doSync);
  els.recalcBtn?.addEventListener("click", recalcAll);
  // 初期
  recalcAll();
  </script>
</body>
</html>
